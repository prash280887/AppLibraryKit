trigger:
  branches:
    include:
    - main
  paths:
    include:
    - APPS/**
    - DEPLOYMENT/AZUREPIPELINES/terraform/**

pr: none  # No PR builds for deployment pipeline

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '18.x'
  terraformVersion: '1.6.0'
  environment: 'prod'
  location: 'eastus'

stages:
  # ========================================
  # Stage 1: Build React for Production
  # ========================================
  - stage: BuildReactProduction
    displayName: 'Build React SPA (Production)'
    jobs:
      - job: BuildReactProd
        displayName: 'Build React Production Bundle'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Setup Node.js $(NODE_VERSION)'

          - task: Npm@1
            inputs:
              command: 'ci'
              workingDir: 'APPS/reactwebappdemo'
            displayName: 'npm ci (clean install)'

          - task: Npm@1
            inputs:
              command: 'custom'
              workingDir: 'APPS/reactwebappdemo'
              customCommand: 'run build'
            displayName: 'Build React app'
            env:
              CI: true
              REACT_APP_API_BASE_URL: '$(ReactAppApiBaseUrl)'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'APPS/reactwebappdemo/build'
              ArtifactName: 'react-build-prod'
              publishLocation: 'Container'
            displayName: 'Publish React build artifacts'

  # ========================================
  # Stage 2: Build .NET API for Production
  # ========================================
  - stage: BuildDotNetProduction
    displayName: 'Build .NET 8 API (Production)'
    jobs:
      - job: BuildDotNetProd
        displayName: 'Build .NET Production Package'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: UseDotNet@2
            inputs:
              version: $(DOTNET_VERSION)
              packageType: 'sdk'
            displayName: 'Use .NET SDK $(DOTNET_VERSION)'

          - task: DotNetCoreCLI@2
            inputs:
              command: 'restore'
              projects: 'APPS/webapiservicedemo/WebApiDemo.csproj'
            displayName: 'Restore NuGet packages'

          - task: DotNetCoreCLI@2
            inputs:
              command: 'build'
              projects: 'APPS/webapiservicedemo/WebApiDemo.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'
            displayName: 'Build .NET solution'

          - task: DotNetCoreCLI@2
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: 'APPS/webapiservicedemo/WebApiDemo.csproj'\n              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
              zipAfterPublish: true
            displayName: 'Publish .NET app'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'dotnet-publish-prod'
              publishLocation: 'Container'
            displayName: 'Publish .NET artifacts'

  # ========================================
  # Stage 3: Infrastructure Deployment (Terraform)
  # ========================================
  - stage: InfrastructureDeployment
    displayName: 'Deploy Infrastructure (Terraform)'
    dependsOn:
    - BuildReactProduction
    - BuildDotNetProduction
    condition: succeeded()
    jobs:
      - deployment: TerraformDeploy
        displayName: 'Terraform Plan & Apply'
        environment: '$(EnvironmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout code'

                - task: TerraformInstaller@0
                  inputs:
                    terraformVersion: $(terraformVersion)
                  displayName: 'Install Terraform $(terraformVersion)'

                - task: TerraformTaskV4@4
                  inputs:
                    provider: 'azurerm'
                    command: 'init'
                    workingDirectory: '$(System.DefaultWorkingDirectory)/DEPLOYMENT/AZUREPIPELINES/terraform'
                    backendServiceArm: '$(AzureServiceConnection)'
                    backendAzureRmResourceGroupName: '$(TfBackendResourceGroup)'
                    backendAzureRmStorageAccountName: '$(TfBackendStorageAccount)'
                    backendAzureRmContainerName: '$(TfBackendContainer)'
                    backendAzureRmKey: '$(TfBackendKey)'
                  displayName: 'Terraform init'

                - task: TerraformTaskV4@4
                  inputs:
                    provider: 'azurerm'
                    command: 'plan'
                    workingDirectory: '$(System.DefaultWorkingDirectory)/DEPLOYMENT/AZUREPIPELINES/terraform'
                    environmentServiceNameAzureRM: '$(AzureServiceConnection)'
                    commandOptions: '-var="environment=$(environment)" -var="location=$(location)" -var="project_name=$(ProjectName)" -var="subscription_id=$(AzureSubscriptionId)" -var="client_id=$(AzureClientId)" -var="client_secret=$(AzureClientSecret)" -var="tenant_id=$(AzureTenantId)" -out=tfplan'
                  displayName: 'Terraform plan'

                - script: |
                    cd DEPLOYMENT/AZUREPIPELINES/terraform
                    terraform show -json tfplan > tfplan.json
                  displayName: 'Convert Terraform plan to JSON'

                - task: PublishBuildArtifacts@1
                  inputs:
                    PathtoPublish: 'DEPLOYMENT/AZUREPIPELINES/terraform/tfplan.json'
                    ArtifactName: 'terraform-plan'
                    publishLocation: 'Container'
                  displayName: 'Publish Terraform plan'

                - task: TerraformTaskV4@4
                  inputs:
                    provider: 'azurerm'
                    command: 'apply'
                    workingDirectory: '$(System.DefaultWorkingDirectory)/DEPLOYMENT/AZUREPIPELINES/terraform'
                    environmentServiceNameAzureRM: '$(AzureServiceConnection)'
                    commandOptions: '-auto-approve tfplan'
                  displayName: 'Terraform apply'

                - script: |
                    cd DEPLOYMENT/AZUREPIPELINES/terraform
                    terraform output -json > outputs.json
                  displayName: 'Export Terraform outputs'

                - task: PublishBuildArtifacts@1
                  inputs:
                    PathtoPublish: 'DEPLOYMENT/AZUREPIPELINES/terraform/outputs.json'
                    ArtifactName: 'terraform-outputs'
                    publishLocation: 'Container'
                  displayName: 'Publish Terraform outputs'

  # ========================================
  # Stage 4: Deploy React to Azure Storage
  # ========================================
  - stage: DeployReactToStorage
    displayName: 'Deploy React to Azure Storage'
    dependsOn:
    - BuildReactProduction
    - InfrastructureDeployment
    condition: succeeded()
    jobs:
      - deployment: DeployReact
        displayName: 'Deploy React SPA'
        environment: '$(EnvironmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'react-build-prod'
                    downloadPath: '$(System.ArtifactsDirectory)'
                  displayName: 'Download React artifacts'

                - task: AzureCLI@2
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az storage blob upload-batch \
                        --account-name $(StorageAccountName) \
                        --destination '$web' \
                        --source $(System.ArtifactsDirectory)/react-build-prod \
                        --overwrite
                  displayName: 'Upload React build to Azure Storage'

                - task: AzureCLI@2
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az cdn endpoint purge \
                        --resource-group $(ResourceGroupName) \
                        --profile-name $(CDNProfileName) \
                        --name $(CDNEndpointName) \
                        --content-paths "/*" || echo "CDN purge skipped"
                  displayName: 'Purge CDN cache'
                  continueOnError: true

  # ========================================\n  # Stage 5: Deploy .NET API to App Service\n  # ========================================\n  - stage: DeployDotNetToAppService\n    displayName: 'Deploy .NET API to App Service'\n    dependsOn:\n    - BuildDotNetProduction\n    - InfrastructureDeployment\n    condition: succeeded()\n    jobs:\n      - deployment: DeployDotNet\n        displayName: 'Deploy .NET API'\n        environment: '$(EnvironmentName)'\n        strategy:\n          runOnce:\n            deploy:\n              steps:\n                - task: DownloadBuildArtifacts@0\n                  inputs:\n                    buildType: 'current'\n                    downloadType: 'single'\n                    artifactName: 'dotnet-publish-prod'\n                    downloadPath: '$(System.ArtifactsDirectory)'\n                  displayName: 'Download .NET artifacts'\n\n                - task: AzureWebApp@1\n                  inputs:\n                    azureSubscription: '$(AzureServiceConnection)'\n                    appType: 'webAppLinux'\n                    appName: '$(AppServiceName)'\n                    package: '$(System.ArtifactsDirectory)/dotnet-publish-prod'\n                    deploymentMethod: 'zipDeploy'\n                  displayName: 'Deploy to Azure App Service'\n\n                - task: AzureCLI@2\n                  inputs:\n                    azureSubscription: '$(AzureServiceConnection)'\n                    scriptType: 'bash'\n                    scriptLocation: 'inlineScript'\n                    inlineScript: |\n                      sleep 10\n                      STATUS=$(curl -s -o /dev/null -w \"%{http_code}\" https://$(AppServiceName).azurewebsites.net/swagger)\n                      if [ $STATUS -eq 200 ]; then\n                        echo \"✓ App Service is healthy (HTTP $STATUS)\"\n                      else\n                        echo \"⚠ App Service returned status: $STATUS\"\n                      fi\n                  displayName: 'Health check - Swagger endpoint'\n                  continueOnError: true\n\n  # ========================================\n  # Stage 6: Deployment Summary\n  # ========================================\n  - stage: DeploymentSummary\n    displayName: 'Deployment Summary'\n    dependsOn:\n    - DeployReactToStorage\n    - DeployDotNetToAppService\n    condition: always()\n    jobs:\n      - job: SummaryJob\n        displayName: 'Generate Summary Report'\n        steps:\n          - task: DownloadBuildArtifacts@0\n            inputs:\n              buildType: 'current'\n              downloadType: 'single'\n              artifactName: 'terraform-outputs'\n              downloadPath: '$(System.ArtifactsDirectory)'\n            displayName: 'Download Terraform outputs'\n            continueOnError: true\n\n          - script: |\n              echo \"##[group]Deployment Summary\"\n              echo \"Build ID: $(Build.BuildId)\"\n              echo \"Build Number: $(Build.BuildNumber)\"\n              echo \"Source Branch: $(Build.SourceBranch)\"\n              echo \"Repository: $(Build.Repository.Name)\"\n              echo \"\"\n              echo \"Deployment Status:\"\n              echo \"  React SPA: $(Resources.Deployments.DeployReact.result)\"\n              echo \"  .NET API: $(Resources.Deployments.DeployDotNet.result)\"\n              echo \"  Infrastructure: $(Resources.Deployments.TerraformDeploy.result)\"\n              echo \"\"\n              if [ -f \"$(System.ArtifactsDirectory)/terraform-outputs/outputs.json\" ]; then\n                echo \"Infrastructure Outputs:\"\n                cat $(System.ArtifactsDirectory)/terraform-outputs/outputs.json | jq .\n              fi\n              echo \"##[endgroup]\"\n            displayName: 'Display deployment summary'\n            continueOnError: true\n\n          - task: PublishBuildArtifacts@1\n            inputs:\n              PathtoPublish: '$(System.ArtifactsDirectory)'\n              ArtifactName: 'deployment-summary'\n              publishLocation: 'Container'\n            displayName: 'Publish deployment summary'\n            continueOnError: true\n