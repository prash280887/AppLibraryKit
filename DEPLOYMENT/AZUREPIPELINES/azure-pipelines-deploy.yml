trigger:
  branches:
    include:
    - main
  paths:
    include:
    - APPS/**
    - DEPLOYMENT/AZUREPIPELINES/terraform/**

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '18.x'
  terraformVersion: '1.6.0'
  environment: 'prod'
  location: 'eastus'

stages:
  # ========================================
  # Stage 1: Build React for Production
  # ========================================
  - stage: BuildReactProduction
    displayName: 'Build React SPA (Production)'
    jobs:
      - job: BuildReactProd
        displayName: 'Build React Production Bundle'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Setup Node.js $(NODE_VERSION)'

          - task: Npm@1
            inputs:
              command: 'ci'
              workingDir: 'APPS/reactwebappdemo'
            displayName: 'npm ci (clean install)'

          - task: Npm@1
            inputs:
              command: 'custom'
              workingDir: 'APPS/reactwebappdemo'
              customCommand: 'run build'
            displayName: 'Build React app'
            env:
              CI: true
              REACT_APP_API_BASE_URL: '$(ReactAppApiBaseUrl)'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'APPS/reactwebappdemo/build'
              ArtifactName: 'react-build-prod'
              publishLocation: 'Container'
            displayName: 'Publish React build artifacts'

  # ========================================
  # Stage 2: Build .NET API for Production
  # ========================================
  - stage: BuildDotNetProduction
    displayName: 'Build .NET 8 API (Production)'
    jobs:
      - job: BuildDotNetProd
        displayName: 'Build .NET Production Package'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: UseDotNet@2
            inputs:
              version: $(DOTNET_VERSION)
              packageType: 'sdk'
            displayName: 'Use .NET SDK $(DOTNET_VERSION)'

          - task: DotNetCoreCLI@2
            inputs:
              command: 'restore'
              projects: 'APPS/webapiservicedemo/WebApiDemo.csproj'
            displayName: 'Restore NuGet packages'

          - task: DotNetCoreCLI@2
            inputs:
              command: 'build'
              projects: 'APPS/webapiservicedemo/WebApiDemo.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'
            displayName: 'Build .NET solution'

          - task: DotNetCoreCLI@2
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: 'APPS/webapiservicedemo/WebApiDemo.csproj'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
              zipAfterPublish: true
            displayName: 'Publish .NET app'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'dotnet-publish-prod'
              publishLocation: 'Container'
            displayName: 'Publish .NET artifacts'

  # ========================================
  # Stage 3: Infrastructure Deployment (Terraform)
  # ========================================
  - stage: InfrastructureDeployment
    displayName: 'Deploy Infrastructure (Terraform)'
    dependsOn:
    - BuildReactProduction
    - BuildDotNetProduction
    condition: succeeded()
    jobs:
      - deployment: TerraformDeploy
        displayName: 'Terraform Plan & Apply'
        environment: '$(EnvironmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout code'

                - task: TerraformInstaller@0
                  inputs:
                    terraformVersion: $(terraformVersion)
                  displayName: 'Install Terraform $(terraformVersion)'

                - task: TerraformTaskV4@4
                  inputs:
                    provider: 'azurerm'
                    command: 'init'
                    workingDirectory: '$(System.DefaultWorkingDirectory)/DEPLOYMENT/AZUREPIPELINES/terraform'
                    backendServiceArm: '$(AzureServiceConnection)'
                    backendAzureRmResourceGroupName: '$(TfBackendResourceGroup)'
                    backendAzureRmStorageAccountName: '$(TfBackendStorageAccount)'
                    backendAzureRmContainerName: '$(TfBackendContainer)'
                    backendAzureRmKey: '$(TfBackendKey)'
                  displayName: 'Terraform init'

                - task: TerraformTaskV4@4
                  inputs:
                    provider: 'azurerm'
                    command: 'plan'
                    workingDirectory: '$(System.DefaultWorkingDirectory)/DEPLOYMENT/AZUREPIPELINES/terraform'
                    environmentServiceNameAzureRM: '$(AzureServiceConnection)'
                    commandOptions: '-var="environment=$(environment)" -var="location=$(location)" -var="project_name=$(ProjectName)" -var="subscription_id=$(AzureSubscriptionId)" -var="client_id=$(AzureClientId)" -var="client_secret=$(AzureClientSecret)" -var="tenant_id=$(AzureTenantId)" -out=tfplan'
                  displayName: 'Terraform plan'

                - script: |
                    cd DEPLOYMENT/AZUREPIPELINES/terraform
                    terraform show -json tfplan > tfplan.json
                  displayName: 'Convert Terraform plan to JSON'

                - task: PublishBuildArtifacts@1
                  inputs:
                    PathtoPublish: 'DEPLOYMENT/AZUREPIPELINES/terraform/tfplan.json'
                    ArtifactName: 'terraform-plan'
                    publishLocation: 'Container'
                  displayName: 'Publish Terraform plan'

                - task: TerraformTaskV4@4
                  inputs:
                    provider: 'azurerm'
                    command: 'apply'
                    workingDirectory: '$(System.DefaultWorkingDirectory)/DEPLOYMENT/AZUREPIPELINES/terraform'
                    environmentServiceNameAzureRM: '$(AzureServiceConnection)'
                    commandOptions: '-auto-approve tfplan'
                  displayName: 'Terraform apply'

                - script: |
                    cd DEPLOYMENT/AZUREPIPELINES/terraform
                    terraform output -json > outputs.json
                  displayName: 'Export Terraform outputs'

                - task: PublishBuildArtifacts@1
                  inputs:
                    PathtoPublish: 'DEPLOYMENT/AZUREPIPELINES/terraform/outputs.json'
                    ArtifactName: 'terraform-outputs'
                    publishLocation: 'Container'
                  displayName: 'Publish Terraform outputs'

  # ========================================
  # Stage 4: Deploy React to Azure Storage
  # ========================================
  - stage: DeployReactToStorage
    displayName: 'Deploy React to Azure Storage'
    dependsOn:
    - BuildReactProduction
    - InfrastructureDeployment
    condition: succeeded()
    jobs:
      - deployment: DeployReact
        displayName: 'Deploy React SPA'
        environment: '$(EnvironmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'react-build-prod'
                    downloadPath: '$(System.ArtifactsDirectory)'
                  displayName: 'Download React artifacts'

                - task: AzureCLI@2
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az storage blob upload-batch \
                        --account-name $(StorageAccountName) \
                        --destination '$web' \
                        --source $(System.ArtifactsDirectory)/react-build-prod \
                        --overwrite
                  displayName: 'Upload React build to Azure Storage'

                - task: AzureCLI@2
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az cdn endpoint purge \
                        --resource-group $(ResourceGroupName) \
                        --profile-name $(CDNProfileName) \
                        --name $(CDNEndpointName) \
                        --content-paths "/*" || echo "CDN purge skipped"
                  displayName: 'Purge CDN cache'
                  continueOnError: true

  # ========================================
  # Stage 5: Deploy .NET API to App Service
  # ========================================
  - stage: DeployDotNetToAppService
    displayName: 'Deploy .NET API to App Service'
    dependsOn:
    - BuildDotNetProduction
    - InfrastructureDeployment
    condition: succeeded()
    jobs:
      - deployment: DeployDotNet
        displayName: 'Deploy .NET API'
        environment: '$(EnvironmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'dotnet-publish-prod'
                    downloadPath: '$(System.ArtifactsDirectory)'
                  displayName: 'Download .NET artifacts'

                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    appType: 'webAppLinux'
                    appName: '$(AppServiceName)'
                    package: '$(System.ArtifactsDirectory)/dotnet-publish-prod'
                    deploymentMethod: 'zipDeploy'
                  displayName: 'Deploy to Azure App Service'

                - task: AzureCLI@2
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      sleep 10
                      STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$(AppServiceName).azurewebsites.net/swagger)
                      if [ $STATUS -eq 200 ]; then
                        echo "✓ App Service is healthy (HTTP $STATUS)"
                      else
                        echo "⚠ App Service returned status: $STATUS"
                      fi
                  displayName: 'Health check - Swagger endpoint'
                  continueOnError: true

  # ========================================
  # Stage 6: Deployment Summary
  # ========================================
  - stage: DeploymentSummary
    displayName: 'Deployment Summary'
    dependsOn:
    - DeployReactToStorage
    - DeployDotNetToAppService
    condition: always()
    jobs:
      - job: SummaryJob
        displayName: 'Generate Summary Report'
        steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'terraform-outputs'
              downloadPath: '$(System.ArtifactsDirectory)'
            displayName: 'Download Terraform outputs'
            continueOnError: true

          - script: |
              echo "##[group]Deployment Summary"
              echo "Build ID: $(Build.BuildId)"
              echo "Build Number: $(Build.BuildNumber)"
              echo "Source Branch: $(Build.SourceBranch)"
              echo "Repository: $(Build.Repository.Name)"
              echo ""
              echo "Deployment Status:"
              echo "  React SPA: DEPLOYED"
              echo "  .NET API: DEPLOYED"
              echo "  Infrastructure: DEPLOYED"
              echo ""
              if [ -f "$(System.ArtifactsDirectory)/terraform-outputs/outputs.json" ]; then
                echo "Infrastructure Outputs:"
                cat $(System.ArtifactsDirectory)/terraform-outputs/outputs.json | jq .
              fi
              echo "##[endgroup]"
            displayName: 'Display deployment summary'
            continueOnError: true

            - task: PublishBuildArtifacts@1
              inputs:
                PathtoPublish: '$(System.ArtifactsDirectory)'
                ArtifactName: 'deployment-summary'
                publishLocation: 'Container'
              displayName: 'Publish deployment summary'
              continueOnError: true
